机器学习设计模式之八：级联

级联(Cascade)设计模式解决了一个机器学习问题可以合理的分解为一系列ML问题的情况。这样的级联通常需要仔细设计ML实验。

**应对问题**

如果我们需要在经常发生和很少发生的活动中预测一个值，会发生什么？该模型将学会忽略这个很少发生的活动，因为它很少见。如果异常活动也与异常值相关，则可训练性就会受到影响。

例如，假设我们正在训练一个模型来预测客户退货的可能性。如果我们训练一个单一的模式，经销商的退货行为将会丢失，因为有数百万的零售买家（和零售交易），而只有几千个经销商。我们真的不知道购买是零售买家还是经销商。然而，通过监控其他市场，我们可以确定从我们那里购买的物品随后何时被转售，所以我们的训练数据集有一个标签，标识购买是由经销商完成的。

解决这个问题的一种方法是在训练模型时加大经销商样本的权重。这不是一个理想的做法，因为我们需要让更常见的零售买家样本尽可能正确。我们不想用整体更低的准确性，以换取经销商样本上的更高准确性。然而，零售买家和经销商的行为非常不同；例如，零售买家在一周内退货，经销商只有在无法出售的情况下才能退货，因此可能在几个月后退货。库存库存的业务决定对于零售买家和经销商的可能回报是不同的。因此，有必要使这两种类型的预测值都尽可能准确。简单地加大经销商的样本将不起作用。

解决这个问题的一种直观的方法是使用级联设计模式。我们将这个问题分为四个部分：

\1. 预测特定交易是否由经销商进行

\2. 训练一种对零售买家的模型模型

\3. 训练向经销商销售的第二种模型

\4. 在生产过程中，结合上述三个独立模型的输出，以预测每个购买商品的退货可能性和由经销商进行交易的概率

这允许根据买家的类型对可能返回的项目做出不同的决定，并确保步骤2和步骤3中的模型在其训练数据上尽可能准确。每一种模型都相对容易训练。第一个只是一个分类器，如果不常见的活动非常罕见，我们可以使用重平衡模式来解决它。接下来的两个模型基本上是在训练数据的不同部分上训练的分类模型。这个组合是确定性的，因为我们根据活动是否属于经销商来选择要运行哪个模型。

问题出现在预测期间。在预测时，我们没有真正的标签，只有第一个分类模型的输出。根据第一个模型的输出，我们必须确定我们调用的两种销售模型中的哪一种。问题是我们是基于标签在做训练，但在推理时，我们必须根据预测做出决定。而预测也是有错误的。因此，第二个和第三个模型将被要求对他们可能在训练中从未见过的数据做出预测。

举一个极端的例子，假设经销商提供的地址总是在城市的一个工业区，而零售买家可以住在任何地方。如果第一个（分类）模型犯了错误，把零售买家错误地识别为经销商，那么其后的退货预测模型将无法准确的预测。

那么我们是如何训练一个模型的输出是下一个模型的输入，或如何选择后续模型哪？

**解决方案**

当一个模型的输出，是下一个模型的输入或用于选择后续模型时的机器学习问题都称为级联。在训练一系列ML模型时，必须特别小心。

例如，涉及异常情况的机器学习问题可以通过将其视为四个机器学习问题的级联来解决：

1.一个用来识别是否异常的分类模型

2.基于异常情况训练一个模型

3.基于典型情况训练一个模型

4.用于组合两个独立模型的输出的模型，输出是上述两个模型输出的概率组合

乍一看，这似乎是集合设计模式的一个特殊情况，不过在进行级联时需要进行特殊的模型设计。

举一个例子，为了估计在车站储存自行车的成本，我们希望预测在旧金山的自行车的租赁站和返回站之间的距离。模型的目标是预测我们把自行车送回租赁位置的距离，输入特征包括租赁开始时间，自行车在何地被租赁，承租人是否是注册用户等等。问题是，超过4小时的租赁与较短的租赁涉及的租赁行为非常不同，但预测模型需要同时输出（租赁超过4小时的概率和自行车需要运输的可能距离）。然而，只有一小部分的租赁涉及到这种异常的长距离旅行。

解决这个问题的一种方法是训练分类模型，首先把旅行分类为长途或典型。

根据租赁的实际持续时间，简单地将训练数据集分成两部分，并训练接下来的两种模型，一种是长途租赁，另一种是典型租赁。问题是刚才讨论的分类模型会有错误。事实上，根据旧金山自行车数据的保留部分来评估模型表明，模型的准确性仅在75%左右（见图3-16）。考虑到这一点，训练一个完全基于数据分割的模型会导致很差的结果。

![img](https://pic1.zhimg.com/80/v2-c07d74f4b841a38205bff68d15d262f4_720w.jpg)

在训练了这个分类模型之后，我们需要使用这个模型的预测结果来创建下一组模型的训练数据集。例如，我们可以为模型创建训练数据集来预测典型租赁的距离。最后，我们的综合三个模型结果来评估预测。应该考虑到我们需要使用三个训练过的模型，而不仅仅是一个。这就是我们所说的级联设计模式。

在实践中，保持级联工作流正常运行很难。与其单独训练模型，最好是使用工作流管道模式（第6章），自动化整个工作流，如图3-17所示。关键是确保每次根据上游模型的预测运行实验时，都要创建这两个下游模型的训练数据集。

![img](https://pic1.zhimg.com/80/v2-034439753ef0908eb9231ae687b78a90_720w.jpg)

图3-17。将模型串联训练为单个工作的管道。

虽然我们引入了级联模式作为在典型和异常活动中做预测的一种方法，但级联模式能够解决更普遍的情况。管道框架允许我们将机器学习问题分解为一系列（或级联）ML问题的任何情况。每当机器学习模型的输出需要作为对另一个模型的输入时，第二个模型就需要对第一个模型的预测进行训练。在所有这些情况下，一个正式的管道实验框架都将会很有帮助。

Kubeflow管道提供了这样一个框架。因为它与容器一起工作，底层机器学习模型和粘合代码几乎可以用任何编程或脚本语言编写。可以提交整个管道进行运行，并使用管道框架跟踪不同的实验运行。

> 如果我们使用TFX作为我们的管道框架(我们可以在kubeflow管道上运行TFX)，那么就没有必要部署上游模型来在下游模型中使用它们的输出预测。相反，我们可以使用tensorflow变换方法tft.apply_saved_model作为预处理操作的一部分。第6章对变形设计模式进行了讨论。

当我们有链式的ML模型时，就强烈建议使用管道实验框架。这样的框架将确保每当修改下游模型时，对下游模型进行重新训练，并且我们有以前所有训练运行的历史。

**权衡和替代**

不要过度使用级联设计模式——与我们在本书中介绍的许多设计模式不同，级联并不一定是一个最佳实践。它为机器学习工作流增加了相当大的复杂性，并可能导致较差的性能。请注意，管道实验框架绝对是最佳实践，但尽可能地将管道限制在单一机器学习问题（数据输入、预处理、数据验证、转换、训练、评估和部署）。如在级联模式中那样，避免在同一管道中使用多个机器学习模型。

- 确定的输入

分割一个ML问题通常是一个坏主意，因为一个ML模型应该学习多个因素的组合。例如：

1. 如果一个条件可以从输入（假日购物和工作日购物）确定，我们应该将该条件作为模型的一个输入维度添加到模型。
2. 如果条件只涉及一个输入的值（一些住在附近和远处的客户，需要从数据中了解近/远的含义），我们可以使用混合输入表示（Mixed Input Representation）来处理它。

级联设计模式解决了一个非典型的场景，数据中并没有作为分类标准的维度，或需要从多个输入中学习极值。

- 单一模型

级联设计模式不应该用于用单个模型就能满足要求的典型场景。例如，我们正在试图了解客户的购买倾向。需要为那些比价购物的人学习不同的模式。我们不知道谁在比价购物，但我们可以根据浏览次数、物品在购物车里停留了多久等来做出猜测。这个问题不需要级联设计模式，因为它很常见（很大部分的客户是比价购物者），因此机器学习模型应该能够在训练过程中隐含地学习它。对于常见的场景，请训练单个模型。

- 一致性

当我们需要在多个模型的预测中保持一致性时，就需要级联。请注意，我们试图做的不仅仅是预测这个非典型活动。我们正试图预测回报，考虑到也会有一些经销商的活动。如果任务只是预测是否由经销商购买，我们可以使用重平衡模式。使用级联的原因是，不平衡的标签输出需要作为对后续模型的输入，并且它本身是有用信息。

同样地，假设我们训练模型来预测客户购买倾向是为了提供折扣优惠。我们是否提供折扣优惠和折扣金额，通常取决于这个客户是否在比价购物。鉴于此，我们需要这两种模式（比价购物模式和购物倾向模型）之间的内部一致性。在这种情况下，就需要级联设计模式。

- 预训练模型

当希望利用预训练模型的输出作为我们模型的输入时，也需要用到级联。例如，假设我们正在建立一个模型来预测进入大楼的授权，以便我们可以自动打开大门。我们的模型的输入之一可能是车辆的车牌。我们没有在模型中直接使用安全照片，我们发现使用光学字符识别(OCR)模型的输出更简单。我们要认识到OCR系统将会有错误，因此我们不应该用实际的车牌信息来训练模型。而应该根据OCR系统的输出来训练模型。事实上，由于不同的OCR模型的行为会不同，并且有不同的错误，所以如果我们改变了OCR系统的供应商，就有必要重新训练该模型。

> 使用预训练模型作为管道第一步的常见场景是使用对象检测模型，然后是细粒度的图像分类模型。例如，对象检测模型可以在图像中找到所有的手袋，中间步骤可以将图像裁剪到被检测对象的边界框中，而随后的模型可以识别手袋的类型。我们建议使用级联，以便每当对象检测模型更新(例如使用新版本的API)时，就可以重新训练整个管道。

- 使用重构而不是级联的场景

请注意，在上述示例中，我们试图预测发生的可能性，这是一个分类问题。假设我们希望预测每小时的销售额。大多数情况下，我们会只对零售买家进行预测，但偶尔（可能每年四五次），我们就会有一个批发商买家。

这在名义上是一个预测每日销售金额的回归问题，其中我们有一个以批发商买家的形式存在的混淆因素。将回归问题重新定义为不同销售额的分类问题可能是一种更好的方法。虽然它将涉及训练每个销售额Bin的分类模型，但它避免了获得正确的零售和批发分类的需要。

- 在非典型情况下的回归

当某些值比其他值更常见时，级联设计模式可以帮助进行回归。例如，我们可能想从卫星图像中预测降雨的数量。99%的像素位置可能不会下雨。在这种情况下，可以帮助创建堆叠分类模型和回归模型：

1. 首先，预测一下它是否会下雨。
2. 对模型预测不太可能降雨的像素位置，设置降雨量为零
3. 对模型预测可能有降雨的像素点，训练一个回归模型来预测像素上的降雨量

重要的是要认识到分类模型是不完美的，因此回归模型必须对分类模型预测的可能下雨的像素进行训练（而不仅仅是标记数据集中可能下雨的像素）。有关解决此问题的补充方案，还请参阅有关“设计模式10：重平衡”和“设计模式5：重构”的讨论